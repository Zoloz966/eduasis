@if (loading) {
<section class="w-full flex justify-content-between px-3">
  <div class="flex gap-2 align-items-center">
    <p-skeleton size="3rem" />
    <!-- <p-button
          icon="pi pi-arrow-left text-lg"
          styleClass="shadow-4 "
          [raised]="true"
        ></p-button> -->
  </div>
  <div class="flex gap-2">
    <div class="flex flex-column justify-content-center gap-1">
      <p-skeleton width="10rem" height="2rem" />
      <p-skeleton width="10rem" height="1rem" />
    </div>
    <p-skeleton size="3rem" />
  </div>
</section>
} @else {
<section class="w-full flex justify-content-between px-3">
  <div class="flex gap-2 align-items-center">
    <p-button
      icon="pi pi-arrow-left text-lg"
      styleClass="shadow-4 "
      [raised]="true"
      (onClick)="goBack()"
    ></p-button>
  </div>
  <div class="flex gap-2">
    <div class="flex flex-column justify-content-center gap-1">
      <div class="text-right">{{ student.name }}</div>
      <div class="text-right text-sm text-700 font-light">
        {{ "Id de estudiante: " + student.id_student }}
      </div>
    </div>
    <p-button
      icon="pi pi-user text-xl"
      styleClass="shadow-4"
      [raised]="true"
    ></p-button>
  </div>
</section>
}

<section
  class="w-full grid align-content-center justify-content-center m-0 mt-3 p-0"
>
  <div class="col-9 md:col-3 px-1 md:px-3">
    <div
      class="w-full relative py-4 overflow-hidden btask-300 shadow-4 btask-1 btask-round flex flex-column md:flex-row justify-content-center align-content-center gap-2"
    >
      <div
        class="absolute surface-50 top-0 w-full pt-1 font-semibold h-2rem text-center"
      >
        ESTUDIANTE
      </div>
      <div class="w-full flex px-3 flex-column gap-2 align-items-center">
        @if (loading) {
        <p-skeleton
          styleClass="w-10rem h-10rem mt-3"
          shape="circle"
        ></p-skeleton>
        <p-skeleton styleClass="w-8rem " height="1.5rem"></p-skeleton>
        <p-skeleton styleClass="w-6rem " height="1.2rem"></p-skeleton>
        <p-skeleton styleClass="w-7rem " height="1.3rem"></p-skeleton>
        <p-skeleton styleClass="w-10rem " height="5rem"></p-skeleton>
        <div class="flex justify-content-center gap-2">
          <p-skeleton size="2rem" shape="circle"></p-skeleton>
          <p-skeleton size="2rem" shape="circle"></p-skeleton>
          <p-skeleton size="2rem" shape="circle"></p-skeleton>
        </div>
        } @else {

        <div
          class="relative surface-50 w-10rem h-10rem mt-3 border-circle flex justify-content-center align-items-center"
        >
          @if (student.photo !== '') {
          <img [src]="student.photo" alt="user-photo" class="w-full" />
          } @else {
          <span class="text-5xl font-medium letter-spacing ml-1"
            ><i class="pi pi-user text-8xl"></i
          ></span>
          }
          <div
            class="absolute bottom-0 border-circle -mb-2 border-3 border-white flex justify-content-center align-items-center bg-primary"
            style="width: 25px; height: 25px"
          ></div>
        </div>
        <div class="text-base font-medium">
          {{ student.name + " " + student.lastname }}
        </div>
        <div class="text-sm text-500 -mt-1">
          <i class="pi pi-id-card"></i> {{ student.id }}
        </div>

        <div class="text-sm font-normal">
          Registro: {{ student.created_at | date : "yyyy-MM-dd" }}
        </div>
        <div class="flex flex-column gap-1 align-items-start text-600">
          <div class="text-sm font-normal flex gap-1 align-items-center">
            <i class="pi pi-envelope text-xs"></i>
            <div>
              {{ truncateString(student.email, 23) }}
            </div>
          </div>
          <div class="text-sm font-normal flex gap-1 align-items-center">
            <i class="pi pi-mobile text-xs"></i>
            <div>
              {{ student.code_country + " " + student.tutor_phone }}
            </div>
          </div>
          <div class="text-sm font-normal flex gap-1 align-items-center">
            <img
              src="../../../assets/icons/icons8-gender-50.png"
              alt="gender"
              class="h-1rem -ml-1"
            />
            <div>
              {{ student.gender }}
            </div>
          </div>
          <div class="text-sm font-normal flex gap-1 align-items-center">
            <svg
              class=""
              fill="#4c4343"
              version="1.1"
              id="Layer_1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              viewBox="0 0 300 300"
              enable-background="new 0 0 300 300"
              xml:space="preserve"
              width="13"
              height="13"
              stroke="#4c4343"
            >
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g
                id="SVGRepo_tracerCarrier"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M8.3,135.1c2.8-33.5,18.8-63.5,44.9-84.6c26.1-21,58.8-30.3,92-25.9c52.3,6.7,75.2,48.8,92.6,87.8 c3.7,8.1,11.8,24.3,15.8,30.3c1.3,1.9,4.2,4.1,7.6,6.5c8.5,6.2,21.4,15.5,30,36.4c1.5,3.7,0.1,8.1-3.4,9.9c-4.1,2-8.9,0.1-10.6-3.9 c-7-17-16.9-24.2-24.9-30c-4.6-3.3-8.5-6.2-11.3-10.3c-5-7.4-13.6-24.9-17-32.7c-16.4-36.8-36.1-73.1-80.6-78.9 C114.4,36,85.8,44,63,62.5c-22.9,18.4-36.8,44.8-39.3,74c-1.5,18.8,2.2,37.1,9.8,53.4c0.9-3.4,2.4-6.5,4.5-9 c5.6-6.9,14-8.5,23.1-4.6c9.8,4.2,14.8,19.5,16.8,28.1c1.8,7.5,5.3,12.1,10.2,13c3.9,0.8,8.3-1.1,10.7-4.7 c3.2-4.6,2.8-10.7-0.9-16.8c-11.8-19.5-7.9-31-2.4-37.3c7.5-8.6,16.9-8.4,27-8c2.8,0.1,5.6,0.1,8.5,0.1c7-0.1,14.1-4.2,19.8-10.8 L139,118.4l-15.9,20.9c-2.4,3.1-5.2,4.3-7.9,5c-11.4,2.5-47.1,9.7-47.1,9.7c-8.3,1.1-14.5-4.1-15.8-10.4 c-1.4-7.3,3.2-14.2,10.4-15.8l19.5-3.9l-20.5-16.7c-5.7-4.6-7-13.1-2.4-18.8c4.6-6,13.2-6.9,19-2.2L110,112l25.3-33.2 c5.7-6.4,11.1-12.2,23.8-12.1c10.2,0.1,19.8,6,25.1,15.4l27.6,50.2c7.6,13.9,2.5,31.3-11.3,38.9c-0.3,0.1-45.5,24.5-45.5,24.5 l10.4,24c2.9,6.7-0.1,14.6-6.9,17.6l0,0c-6.7,2.9-14.6-0.1-17.6-6.9L125.5,195c-2.8-6.5-0.3-13.9,5.9-17.2l31-16.7 c-0.3-0.5-6.6-12-6.6-12c-7.2,7.1-15.9,11.4-24.8,11.6c-3.3,0-6.2,0-9-0.1c-9.9-0.4-14.9-0.3-19,4.5c-5.9,6.7-1.4,17.4,3.4,25.3 c5.9,9.7,6.1,20,0.6,27.9c-4.1,5.9-10.6,9.3-17.3,9.3c-1.1,0-2.4-0.1-3.6-0.4c-8.8-1.7-15.5-9.2-18.2-20.6 c-3.1-12.7-7.6-19.7-10.9-21.1c-5-2.2-8.5-1.5-11.2,1.7c-3.3,4.1-4.5,11.8-2.3,19.8c16.7,23,42.1,39.7,71.6,43.8 c7.2,1,14.6,1.3,22,0.8c17.2-1.1,32.7,2.7,45,11.2c3.4,2.3,4.7,6.9,2.5,10.4c-1.4,2.4-3.9,3.7-6.5,3.7c-1.4,0-3.1-0.5-4.3-1.4 c-12-8.5-25.9-9.4-35.6-8.8c-8.4,0.6-16.8,0.3-25.2-0.9c-30.7-4.2-58.4-20.1-78.1-44.8S6.1,166,8.3,135.1z M213.7,254.6 c21.6,4.7,43-8.9,47.7-30.5c4.7-21.6-8.9-43-30.5-47.7s-43,8.9-47.7,30.5C178.3,228.5,192.1,249.8,213.7,254.6z"
                ></path>
              </g>
            </svg>
            <div>
              {{ student.birth_date.toString().split("T")[0] }}
            </div>
          </div>
          <div class="text-sm font-normal flex gap-1 align-items-center">
            <i class="pi pi-info-circle text-xs"></i>
            <div>
              {{ student.info ? student.info : "Sin informacion adicional" }}
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <p-button
            [rounded]="true"
            severity="secondary"
            icon="pi pi-envelope text-lg"
            (onClick)="sendEmail()"
            styleClass="h-2rem w-2rem"
          />
          <p-button
            [rounded]="true"
            severity="success"
            icon="pi pi-whatsapp text-lg"
            (onClick)="sendWhatsapp()"
            styleClass="h-2rem w-2rem"
          />
          <p-button
            [rounded]="true"
            severity="secondary"
            [icon]="'pi pi-pencil text-lg'"
            styleClass="h-2rem w-2rem"
            (onClick)="showStudent()"
          />
        </div>
        }
      </div>
    </div>
  </div>
  <div class="col-12 md:col-9 px-3 md:px-3 mb-7 md:mb-0">
    <div
      class="w-full relative py-4 overflow-hidden btask-300 shadow-4 btask-1 btask-round p-0 flex flex-column justify-content-center align-content-center gap-2"
    >
      <div
        class="absolute surface-50 top-0 w-full pt-1 font-semibold h-2rem text-center"
      >
        DETALLES DEL ESTUDIANTE
      </div>
      <p-tabView styleClass="mt-2 tabview-custom">
        <p-tabPanel>
          <ng-template pTemplate="header">
            <div class="flex align-items-center gap-2">
              <i class="pi text-base pi-check"></i>
              <span class="font-bold white-space-nowrap m-0"> Tareas </span>
            </div>
          </ng-template>
          @if (loadingDetails) { @for (skeleton of skeletons; track $index) {
          <div
            class="w-full btask-bottom-1 btask-300 flex flex-column gap-2 py-2"
          >
            <div class="flex justify-content-between">
              <p-skeleton styleClass="w-3rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-7rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-5rem" height="1.5rem"></p-skeleton>
            </div>
            <div class="flex justify-content-between">
              <p-skeleton
                styleClass="w-5rem md:w-14rem"
                height="1.3rem"
              ></p-skeleton>
              <p-skeleton styleClass="w-9rem" height="1.3rem"></p-skeleton>
            </div>
            <div class="flex justify-content-between">
              <p-skeleton styleClass="w-8rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-9rem" height="1.3rem"></p-skeleton>
            </div>
            <div class="flex justify-content-between">
              <p-skeleton styleClass="w-3rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-7rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-5rem" height="1.5rem"></p-skeleton>
            </div>
          </div>
          } } @else { @for (task of tasks; track task.id_task; ) {
          <div
            class="hover:surface-50 px-2 w-full btask-bottom-1 btask-300 flex flex-column gap-2 py-2"
          >
            <div
              class="flex text-sm justify-content-between align-items-center"
            >
              <p-chip
                [label]="($index + 1).toString()"
                icon="pi pi-check-circle"
              />
              <div class="flex gap-1 align-items-center">
                <i class="pi pi-calendar text-base"></i>
                {{ task.end_date | date : "yyyy/MM/dd" }}
              </div>
              <p-tag
                [value]="task.isCompleted ? 'Completado' : 'Incompleta'"
                [severity]="task.isCompleted === 1 ? 'success' : 'info'"
              ></p-tag>
            </div>

            <div
              class="flex text-sm justify-content-between align-items-center"
            >
              <div class="flex gap-1 font-semibold align-items-center">
                {{ task.task_tittle }}
              </div>
              <div class="flex gap-1 align-items-center">
                <i class="pi text-base pi-clipboard"></i>
                {{ task.class?.class_name }}
              </div>
            </div>

            <div
              class="flex text-sm justify-content-between align-items-center gap-2"
            >
              <div class="flex gap-1 align-items-center">
                <i class="pi text-base pi-info-circle"></i>
                {{
                  task.description
                    ? task.description
                    : "Sin detalles adicionales"
                }}
              </div>
              <div class="flex gap-1 align-items-center">
                <span>{{
                  task.class?.course?.course_name +
                    " " +
                    task.class?.course?.parallel
                }}</span>
              </div>
              @if(!task.isCompleted){
              <div class="flex align-items-center gap-2">
                <span class="text-sm">Marcar</span>
                <p-checkbox
                  name="task_complete"
                  [disabled]="task.isCompleted ? true : false"
                  [(ngModel)]="task.isCompleted"
                  [binary]="true"
                  inputId="binary"
                  (onChange)="handleCompletedTask(task)"
                />
              </div>
              }
            </div>
          </div>
          } @empty {
          <p class="font-italic">No se encontraron tareas registradas</p>
          } }
        </p-tabPanel>
        <p-tabPanel>
          <ng-template pTemplate="header">
            <div class="flex align-items-center gap-2">
              <i class="pi text-base pi-clipboard"></i>
              <span class="font-bold white-space-nowrap m-0"> Clases </span>
            </div>
          </ng-template>
          @if (loadingDetails) { @for (skeleton of skeletons; track $index) {
          <div
            class="w-full btask-bottom-1 btask-300 flex flex-column gap-2 py-2"
          >
            <div class="flex justify-content-between">
              <p-skeleton styleClass="w-3rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-10rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-5rem" height="1.5rem"></p-skeleton>
            </div>

            <div class="flex justify-content-between">
              <p-skeleton styleClass="w-6rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-5rem" height="1.3rem"></p-skeleton>
              <p-skeleton styleClass="w-7rem" height="1.5rem"></p-skeleton>
            </div>
          </div>
          } } @else { @for (class of classes; track $index) {
          <div
            class="w-full flex justify-content-between px-3 py-2 my-1 hover:surface-50"
          >
            <div>
              <i class="pi pi-clipboard mr-1"></i> {{ class.class_name }}
            </div>
            <div>
              <i
                [class]="
                  getTaskCompleted(class.tasks!) === class.tasks!.length
                    ? 'pi pi-check-circle text-green-500 mr-2'
                    : 'pi pi-check-circle mr-2'
                "
              ></i>
              <span class="text-primary">{{
                getTaskCompleted(class.tasks!)
              }}</span>
              {{ " / " + class.tasks?.length }}
            </div>
          </div>
          } @empty {
          <p class="font-italic">No se encontraron clases registrados</p>
          } }
        </p-tabPanel>
        <p-tabPanel>
          <ng-template pTemplate="header">
            <div class="flex align-items-center gap-2">
              <i class="pi text-base pi-chart-line"></i>
              <span class="font-bold white-space-nowrap m-0">
                Calificaciones
              </span>
            </div>
          </ng-template>
          <p-table
            [value]="classes"
            styleClass="p-datatable-sm "
            rowGroupMode="rowspan"
            groupRowsBy="subject.type_subject"
            sortField="subject.type_subject"
            sortMode="single"
          >
            <ng-template pTemplate="header">
              <tr>
                <th class="pl-2 surface-50 h-3rem text-center" rowspan="2">
                  CAMPOS DE SABERES Y CONOCIMIENTOS
                </th>
                <th
                  class="white-space-nowrap surface-50 h-3rem text-center"
                  rowspan="2"
                >
                  ÁREAS CURRICULARES
                </th>
                <!-- Colspan para combinar las celdas en una sola columna -->
                <th class="surface-50 h-3rem text-center" colspan="4">
                  VALORACIÓN CUANTITATIVA
                </th>
              </tr>
              <tr>
                <!-- Encabezados de los trimestres alineados -->
                <th class="surface-50 h-3rem text-xs text-center">
                  1er Trimestre
                </th>
                <th class="surface-50 h-3rem text-xs text-center">
                  2do Trimestre
                </th>
                <th class="surface-50 h-3rem text-xs text-center">
                  3er Trimestre
                </th>
                <th class="surface-50 h-3rem text-xs text-center">
                  PROMEDIO ANUAL
                </th>
              </tr>
            </ng-template>
            <ng-template
              pTemplate="body"
              let-class
              let-rowIndex="rowIndex"
              let-rowgroup="rowgroup"
              let-rowspan="rowspan"
            >
              @if (loadingDetails) { @for (skeleton of skeletons; track $index)
              {
              <tr>
                <td class="pl-3 flex gap-2 align-items-center">
                  <p-skeleton size="2rem" shape="circle"></p-skeleton>
                  <p-skeleton height="1rem" width="8rem"></p-skeleton>
                </td>
                <td>
                  <p-skeleton height="1rem" width="9rem"></p-skeleton>
                </td>
                <td>
                  <p-skeleton height="1rem" width="9rem"></p-skeleton>
                </td>
                <td>
                  <p-skeleton height="1rem" width="9rem"></p-skeleton>
                </td>
                <td class="flex gap-2 align-items-center">
                  <p-skeleton size="2rem" shape="circle"></p-skeleton>
                  <p-skeleton size="2rem" shape="circle"></p-skeleton>
                  <p-skeleton size="2rem" shape="circle"></p-skeleton>
                </td>
              </tr>
              } } @else {
              <tr>
                <td
                  class="text-center"
                  *ngIf="rowgroup"
                  [attr.rowspan]="rowspan"
                >
                  <span class="font-bold ml-2 text-center">{{
                    class.subject.type_subject | uppercase
                  }}</span>
                </td>
                <td>{{ class.class_name }}</td>
                <td
                  [class]="
                    getFirstgrade(class.grades) < 51 ? 'text-red-500' : ''
                  "
                >
                  {{ +getFirstgrade(class.grades) }}
                </td>
                <td
                  [class]="
                    getSecondgrade(class.grades) < 51 ? 'text-red-500' : ''
                  "
                >
                  {{ +getSecondgrade(class.grades) }}
                </td>
                <td
                  [class]="
                    getThirdgrade(class.grades) < 51 ? 'text-red-500' : ''
                  "
                >
                  {{ +getThirdgrade(class.grades) }}
                </td>
                <td
                  [class]="
                    +getAverageGrade(class.grades) < 51 ? 'text-red-500' : ''
                  "
                >
                  {{ +getAverageGrade(class.grades).toFixed(2) }}
                </td>
              </tr>
              }
            </ng-template>
          </p-table>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>
</section>

<p-toast position="top-center"></p-toast>
<p-confirmDialog styleClass="w-auto md:w-5" position="bottom"></p-confirmDialog>
